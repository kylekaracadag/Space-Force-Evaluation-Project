@inject IUserData userData
@inject IRequestsData requestsData
@inject ISnackbar Snackbar
@inject ITeamsData teamsData


<MudDialog Style="border-radius: 15px;
            background: #E7F1FF;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25), 0px 4px 4px rgba(0, 0, 0, 0.25), 0px 4px 4px rgba(0, 0, 0, 0.25);">
    <DialogContent>
        <MudGrid>
            <MudItem xs="6">
                <div style="border-right: solid 1px; padding-right:5px; height:100%;">
                    <h6 style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 130%;">User Being Outsourced</h6>

                    <p class="adcon-dialogue"><b style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 100%;">User:</b> @user.firstName @user.lastName</p>
                    <p><b style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 100%;">Rank:</b> @user.rank</p>
                    <p><b style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 100%;">Job:</b> @user.job</p>
                    <p><b style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 100%;">Role:</b> @user.role</p>
                </div>
            </MudItem>
            @if(newTeamLeader != null)
            {
                <MudItem xs="6">
                    <div style="padding-right:5px; height:100%; width:100%">
                        <h6 style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 130%;">Potential New Team</h6>

                        <p class="adcon-dialogue"><b style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 100%;">Team</b>: @newTeam.name</p>
                        <p><b style="font-family: 'HelveticaNeueBold'; font-style: normal; font-weight: 400; font-size: 100%;">Team Leader:</b> @newTeamLeader.firstName @newTeamLeader.lastName</p>
                    </div>
                </MudItem>
            }
            
        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton Style="font-family: HelveticaNeueMedium;" OnClick="Cancel">Cancel</MudButton>

        @if (canApproveOrDeny)
        {
            <MudButton Style="font-family: HelveticaNeueMedium;" Disabled="@(processingRequest || (currentStatus != "Pending" && currentStatus != "Awaiting second response"))"
                   OnClick="() => onApproval()">Approve</MudButton>

            <MudButton Style="font-family: HelveticaNeueMedium;" Disabled="@(processingRequest || (currentStatus != "Pending" && currentStatus != "Awaiting second response"))"
                   OnClick="() => denyRequests()">Deny</MudButton>
        }
    </DialogActions>


</MudDialog>



@code {
    public class OPCONOutsourceRequests
    {
        public UserModel user;
        public TeamsModel newTeam;
        public RequestsModel request;
        public String status;
    }

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public TeamsModel newTeam { get; set; }
    [Parameter] public UserModel user { get; set; }
    [Parameter] public String currentStatus { get; set; }
    [Parameter] public Action<string> UpdateStatus { get; set; }
    [Parameter] public bool canApproveOrDeny { get; set; }
    [Parameter] public bool requiresMultipleApprovals { get; set; }

    public UserModel newTeamLeader;

    void Submit() => MudDialog.Close(DialogResult.Ok(true));
    void Cancel() => MudDialog.Cancel();

    bool processingRequest = false;

    public async Task<bool> addUserToTeam(string userID, string teamID)
    {
        TeamsModel team = await teamsData.GetTeam(teamID);

        if(team.members.Contains(userID))
        {
            return false;
        }

        team.members.Add(userID);
        await teamsData.UpdateTeam(team);

        return true;
    }

    async Task onApproval()
    {
        processingRequest = true;
        // TODO: check if there need to be a second aproval first
        if (requiresMultipleApprovals)
        {
            UpdateStatus("Awaiting second response");
            currentStatus = "Awaiting second response";
            Snackbar.Add("Successfully approved evaluation requests. Wait for other approvals", Severity.Success);
        }
        else
        {
            bool result = await addUserToTeam(user.userID, newTeam.ObjectId);

            if (result)
            {
                UpdateStatus("Approved");
                currentStatus = "Approved";
                Snackbar.Add("Successfully approved evaluation requests.", Severity.Success);
            }
            else
            {
                UpdateStatus("Error");
                currentStatus = "Error";
                Snackbar.Add("Error: user is already in team", Severity.Error);
            }
        }
        
        processingRequest = false;
    }


    async Task denyRequests()
    {
        UpdateStatus("Denied");
        currentStatus = "Denied";
        Snackbar.Add("Successfully denied evaluation requests.", Severity.Success);
        StateHasChanged();
    }


    protected async override Task OnInitializedAsync()
    {
        newTeamLeader = await userData.GetUser(newTeam.leader);
    }
}